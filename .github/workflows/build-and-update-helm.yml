name: Build image and update Helm

on:
  push:
    tags:
      - 'dev-v*'

permissions:
  contents: write    # нужно чтобы actions мог пушить в другой репо если используешь GITHUB_TOKEN (ограничено)
  id-token: write

jobs:
  build-and-update:
    runs-on: ubuntu-latest
    env:
      DOCKER_REGISTRY: docker.io
      IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/demo-app

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v2

      - name: Setup buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract tag
        id: vars
        run: echo "TAG=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: Build and push image
        run: |
          IMG=${{ env.IMAGE_NAME }}:${{ env.TAG }}
          docker build -t $IMG .
          docker push $IMG

      - name: Clone Helm repo
        env:
          HELM_REPO: ${{ github.repository_owner }}/demo-app-helm
        run: |
          # use PAT if helm repo is private; GH_TOKEN can work for public update via checkout? safer to use PAT stored in secrets
          git clone https://github.com/${HELM_REPO}.git helm-repo
          cd helm-repo
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Update values.yaml with new tag
        run: |
          cd helm-repo
          # replace the tag line - this is simple sed, adapt if YAML format different
          TAG=${{ env.TAG }}
          # Use yq if you want robust YAML changes; but sed is simplest:
          sed -i "s|^  tag:.*|  tag: ${TAG}|" values.yaml || true
          git add values.yaml
          git commit -m "ci: update image tag to ${TAG}" || echo "no changes to commit"
          # push back - if repo is private you'll need to use a PAT in HTTPS URL
          git push origin HEAD

      # If helm-repo is private use:
      # git clone https://<PAT>@github.com/${HELM_REPO}.git helm-repo
      # and store PAT in secrets. Example below in notes.
